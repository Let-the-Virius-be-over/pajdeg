<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Pajdeg: Adding metadata to a PDF</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Pajdeg
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   <div id="projectbrief">Pajdeg</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="a00008.html">Quick Start</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Adding metadata to a PDF </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>From <code>examples/add-metadata.c</code> :</p>
<p>We now want to add metadata to an existing PDF. If the PDF has metadata already, we explode, but that's fine, we'll deal with that soon. The first new thing we have to do is declare a <em>mutator</em> task function above <code>main</code>.</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>It takes four arguments: the pipe, its owning task, the object it's supposed to do its magic on, and an info object that we can use to store info in. We'll get to this function in a bit.</p>
<p>The next thing we have to do is create a new object. This is actually done straight off without using tasks. It may be a little confusing at first, but a mutator <em>mutates/changes</em> something, it never <em>creates</em> anything.</p>
<p>In any case, to create objects, we need to introduce a new friend, the parser. In our <code>main()</code>:</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>The object has been given a unique object ID and is set up, ready to be stuffed into the output PDF as soon as we hit <code>execute</code>.</p>
<p>We want to tweak it first, of course. Here, we're setting the metadata to our own string. The two flags at the end are used to tell the object if we want it to set the Length property using our provided length, and whether the passed buffer needs to be freed after the object is finished using it. If you <code>strdup()</code>'d a string and passed it in, you would give <code>true</code> as the last argument, unless you planned to <code>free()</code> it yourself once you knew the object was done with it.</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>Adding a metadata object is fine and all, but it won't do any good unless we point the PDF's root object at the new metadata object. That's what our task from before is for.</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>We're creating a mutator task for the "root object" property type (i.e. the root object of the PDF), and we're passing our <code>addMetadata</code> function to it, and finally we're setting the <code>info</code> object to the <code>meta</code> object we made earlier.</p>
<p>Under the hood, this sets up a filter task for the root object's object ID, and attaches a mutator task to that filter task. The filter task will be pinged every time an object passes through the pipe and if the filter encounters the object whose ID matches the root object of the PDF, it will trigger its mutator task and hand it the object in question. That mutator task is our <code>addMetadata</code> function.</p>
<p>Which we will get to very soon. Before we do, though, there are a few things left: adding our task to the pipe,</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>executing the pipe,</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>and some clean-up.</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>Caution: releasing the meta object before calling <a class="el" href="a00127.html#ga0250f0103c839ae4ffb95a07e53ca108">PDPipeExecute()</a> will cause a crash, because <code>addMetadata</code> uses it and <code>addMetadata</code> is not called until <a class="el" href="a00127.html#ga0250f0103c839ae4ffb95a07e53ca108">PDPipeExecute()</a> has been called.</p>
<p>The last part is the actual task callback.</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>We could blindly change the root object's Metadata key to point to our new object. We could, but it would be very bad. We would leave a potentially huge abandoned object in the resulting PDF. Even worse, a PDF would have as many metadata objects as it had gone through our pipe, since we would be adding a new one every time.</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>If PDObjectGetDictionaryEntry() returns a non-NULL value for the "Metadata" key, we explode. With that out of the way, setting the metadata is fairly straightforward.</p>
<p>We get the reference string for the meta object,</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>stuff it into the root object,</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>and return PDTaskDone to signal that we're finished:</p>
<p><div class="fragment"></div><!-- fragment --></p>
<p>Put together, this is what it all looks like:</p>
<div class="fragment"></div><!-- fragment --><p>You can check out a dissection of a <code>diff</code> resulting from a tiny PDF when piped using this program on the <a class="el" href="a00014.html">Add metadata diff example</a> page.</p>
<p>In the next part we'll be conditionally replacing or inserting metadata depending on whether it exists or not. There are a couple of ways of doing this, such as always deleting the current medata object and putting in a new one, but we're going to replace or insert.</p>
<p>Next up: <a class="el" href="a00016.html">Replacing metadata</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jul 27 2014 13:28:29 for Pajdeg by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
