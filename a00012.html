<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Pajdeg: Adding metadata to a PDF</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Pajdeg
   &#160;<span id="projectnumber">0.0.5</span>
   </div>
   <div id="projectbrief">Pajdeg</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="a00008.html">Quick Start</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Adding metadata to a PDF </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>From <code>samples/add-metadata.c</code> :</p>
<p>We now want to add metadata to an existing PDF. If the PDF has metadata already, we explode, but that's fine, we'll deal with that soon. The first new thing we have to do is declare a <em>mutator</em> task function above <code>main</code>.</p>
<p><div class="fragment"><div class="line"><a class="code" href="a00136.html#ga91616478cbeb225ea1dc8684f4daaa09">PDTaskResult</a> addMetadata(<a class="code" href="a00021.html#a00159">PDPipeRef</a> pipe, <a class="code" href="a00021.html#a00171">PDTaskRef</a> task, <a class="code" href="a00026.html#a00152">PDObjectRef</a> <span class="keywordtype">object</span>, <span class="keywordtype">void</span> *info);</div>
</div><!-- fragment --></p>
<p>It takes four arguments: the pipe, its owning task, the object it's supposed to do its magic on, and an info object that we can use to store info in. We'll get to this function in a bit.</p>
<p>The next thing we have to do is create a new object. This is actually done straight off without using tasks. It may be a little confusing at first, but a mutator <em>mutates/changes</em> something, it never <em>creates</em> anything.</p>
<p>In any case, to create objects, we need to introduce a new friend, the parser. In our <code>main()</code>:</p>
<p><div class="fragment"><div class="line">    <span class="comment">// get the pipe&#39;s parser</span></div>
<div class="line">    <a class="code" href="a00021.html#a00158">PDParserRef</a> parser = <a class="code" href="a00127.html#gac21c2aa259c604582e175bb09887d5ca">PDPipeGetParser</a>(pipe);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;- adding metadata object\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// add a brand spanking new object to the PDF</span></div>
<div class="line">    <a class="code" href="a00026.html#a00152">PDObjectRef</a> meta = <a class="code" href="a00019.html#ga5c564a25ae062c5ded85d3de28bad85a">PDParserCreateNewObject</a>(parser);</div>
</div><!-- fragment --></p>
<p>The object has been given a unique object ID and is set up, ready to be stuffed into the output PDF as soon as we hit <code>execute</code>.</p>
<p>We want to tweak it first, of course. Here, we're setting the metadata to our own string. The three flags at the end are used to tell the object if we want it to set the Length property using our provided length, whether the passed buffer needs to be freed after the object is finished using it, and whether the passed content is encrypted or not. If you <code>strdup()</code>'d a string and passed it in, you would give <code>true</code> as the second argument, unless you planned to <code>free()</code> it yourself once you knew the object was done with it.</p>
<p><div class="fragment"><div class="line">    <span class="keywordtype">char</span> *metaString = <span class="stringliteral">&quot;Hello World!&quot;</span>;</div>
<div class="line">    <a class="code" href="a00026.html#ga45ac52885d1710e54e2271870b8c13f8">PDObjectSetStream</a>(meta, metaString, strlen(metaString), <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div>
</div><!-- fragment --></p>
<p>Adding a metadata object is fine and all, but it won't do any good unless we point the PDF's root object at the new metadata object. That's what our task from before is for.</p>
<p><div class="fragment"><div class="line">    <a class="code" href="a00021.html#a00171">PDTaskRef</a> rootUpdater = </div>
<div class="line">        <a class="code" href="a00136.html#ga6405c8eb09d5f957e1b7911f743fd489">PDTaskCreateMutatorForPropertyType</a>(<a class="code" href="a00136.html#ggaa2f108018ee986118e960c9004e65f44a4527237134f3627f5a0d387625c6b0b2">PDPropertyRootObject</a>,</div>
<div class="line">                                           addMetadata);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// pass it the meta object as its info</span></div>
<div class="line">    <a class="code" href="a00136.html#ga4382fcaa073650fc176e1d13d587aa4d">PDTaskSetInfo</a>(rootUpdater, meta);</div>
</div><!-- fragment --></p>
<p>We're creating a mutator task for the "root object" property type (i.e. the root object of the PDF), and we're passing our <code>addMetadata</code> function to it, and finally we're setting the <code>info</code> object to the <code>meta</code> object we made earlier.</p>
<p>Under the hood, this sets up a filter task for the root object's object ID, and attaches a mutator task to that filter task. The filter task will be pinged every time an object passes through the pipe and if the filter encounters the object whose ID matches the root object of the PDF, it will trigger its mutator task and hand it the object in question. That mutator task is our <code>addMetadata</code> function.</p>
<p>Which we will get to very soon. Before we do, though, there are a few things left: adding our task to the pipe,</p>
<p><div class="fragment"><div class="line">    <a class="code" href="a00127.html#gada11ae0da3875e70faab112dff7a7216">PDPipeAddTask</a>(pipe, rootUpdater);</div>
</div><!-- fragment --></p>
<p>executing the pipe,</p>
<p><div class="fragment"><div class="line">    <a class="code" href="a00029.html#ga7bf5d17054ed63682b0cb309545ad1cc">PDInteger</a> obcount = <a class="code" href="a00127.html#ga0250f0103c839ae4ffb95a07e53ca108">PDPipeExecute</a>(pipe);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;- execution finished (%ld objects processed)\n&quot;</span>, obcount);</div>
</div><!-- fragment --></p>
<p>and some clean-up.</p>
<p><div class="fragment"><div class="line">    <a class="code" href="a00138.html#ga19a72abf3c398d15e2e2ba01d38962ef">PDRelease</a>(pipe);</div>
<div class="line">    <a class="code" href="a00138.html#ga19a72abf3c398d15e2e2ba01d38962ef">PDRelease</a>(rootUpdater);</div>
<div class="line">    <a class="code" href="a00138.html#ga19a72abf3c398d15e2e2ba01d38962ef">PDRelease</a>(meta);</div>
</div><!-- fragment --></p>
<p>Caution: releasing the meta object before calling <a class="el" href="a00127.html#ga0250f0103c839ae4ffb95a07e53ca108">PDPipeExecute()</a> will cause a crash, because <code>addMetadata</code> uses it and <code>addMetadata</code> is not called until <a class="el" href="a00127.html#ga0250f0103c839ae4ffb95a07e53ca108">PDPipeExecute()</a> has been called.</p>
<p>The last part is the actual task callback.</p>
<p><div class="fragment"><div class="line"><a class="code" href="a00136.html#ga91616478cbeb225ea1dc8684f4daaa09">PDTaskResult</a> addMetadata(<a class="code" href="a00021.html#a00159">PDPipeRef</a> pipe, <a class="code" href="a00021.html#a00171">PDTaskRef</a> task, <a class="code" href="a00026.html#a00152">PDObjectRef</a> <span class="keywordtype">object</span>, <span class="keywordtype">void</span> *info)</div>
<div class="line">{</div>
</div><!-- fragment --></p>
<p>We could blindly change the root object's Metadata key to point to our new object. We could, but it would be very bad. We would leave a potentially huge abandoned object in the resulting PDF. Even worse, a PDF would have as many metadata objects as it had gone through our pipe, since we would be adding a new one every time.</p>
<p><div class="fragment"><div class="line">    printf(<span class="stringliteral">&quot;- task &#39;addMetadata&#39; starting\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// get the dictionary for the object</span></div>
<div class="line">    <a class="code" href="a00021.html#a00149">PDDictionaryRef</a> dict = <a class="code" href="a00026.html#gabf179b365305f5684f8014e257944e53">PDObjectGetDictionary</a>(<span class="keywordtype">object</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// we will ruthlessly explode if the object already HAS a metadata entry </span></div>
<div class="line">    <span class="comment">// (see replace-metadata.c)</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="a00123.html#gac4fa42edf1c071588eabc761ed842404">PDDictionaryGetEntry</a>(dict, <span class="stringliteral">&quot;Metadata&quot;</span>)) {</div>
<div class="line">        <span class="comment">// normally you would return PDTaskAbort here, instead of killing the </span></div>
<div class="line">        <span class="comment">// entire application</span></div>
<div class="line">        die(<span class="stringliteral">&quot;error: metadata already exists! aborting!\n&quot;</span>);</div>
<div class="line">    }</div>
</div><!-- fragment --></p>
<p>Here, we are using a <a class="el" href="a00021.html#a00149">PDDictionary</a> for the first time. It's simply a key/value pair container, used to represent dictionaries in PDFs. We can get the dictionary associated with a <a class="el" href="a00026.html#a00152">PDObject</a> using <a class="el" href="a00026.html#gabf179b365305f5684f8014e257944e53">PDObjectGetDictionary()</a>. There is a corresponding <a class="el" href="a00026.html#ga8a002e0a8e243178632adceb3ec23181">PDObjectGetArray()</a> for array type objects, and so on.</p>
<p>In any case, if <a class="el" href="a00123.html#gac4fa42edf1c071588eabc761ed842404">PDDictionaryGetEntry()</a> returns a non-NULL value for the "Metadata" key, we explode. With that out of the way, setting the metadata is fairly straightforward.</p>
<p>Our meta object is the info, passed to the task:</p>
<p><div class="fragment"><div class="line">    <a class="code" href="a00026.html#a00152">PDObjectRef</a> meta = info;</div>
</div><!-- fragment --></p>
<p>We put this into the dictionary as the Metadata value:</p>
<p><div class="fragment"><div class="line">    <a class="code" href="a00123.html#ga670d173c477d22e69a89eb4640188141">PDDictionarySetEntry</a>(dict, <span class="stringliteral">&quot;Metadata&quot;</span>, meta);</div>
</div><!-- fragment --></p>
<p>Note that while meta is a <a class="el" href="a00026.html#a00152">PDObject</a>, by setting a <a class="el" href="a00021.html#a00149">PDDictionary</a> entry's value to a <a class="el" href="a00026.html#a00152">PDObject</a>, it will ultimately end up being a <a class="el" href="a00021.html#a00162">PDReference</a> value. In other words, objects will translate into "&lt;object id&gt; &lt;generation number&gt; R" in a <a class="el" href="a00021.html#a00149">PDDictionary</a>, when written to a PDF.</p>
<p>Finally we return PDTaskDone to signal that we're finished:</p>
<p><div class="fragment"><div class="line">    <span class="keywordflow">return</span> <a class="code" href="a00136.html#gga91616478cbeb225ea1dc8684f4daaa09ab91b10f2a3fdb44fe9a8afc269354b08">PDTaskDone</a>;</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<p>Put together, this is what it all looks like:</p>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;../src/Pajdeg.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;../src/PDDictionary.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;../src/PDString.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// convenient way to scream and die</span></div>
<div class="line"><span class="preprocessor">#define die(msg...) do { fprintf(stderr, msg); exit(-1); } while (0)</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// a &quot;mutator&quot; task, which is responsible for pointing the PDF&#39;s root object</span></div>
<div class="line"><span class="comment">// to a new metadata object that we&#39;re creating</span></div>
<div class="line"><a class="code" href="a00136.html#ga91616478cbeb225ea1dc8684f4daaa09">PDTaskResult</a> addMetadata(<a class="code" href="a00021.html#a00159">PDPipeRef</a> pipe, <a class="code" href="a00021.html#a00171">PDTaskRef</a> task, <a class="code" href="a00026.html#a00152">PDObjectRef</a> <span class="keywordtype">object</span>, <span class="keywordtype">void</span> *info);</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// main program</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// want in and out files as arguments</span></div>
<div class="line">    <span class="keywordflow">if</span> (argc != 3) die(<span class="stringliteral">&quot;syntax: %s &lt;input PDF file&gt; &lt;output PDF name&gt;\n&quot;</span>, argv[0]);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;creating pipe\n&quot;</span> </div>
<div class="line">           <span class="stringliteral">&quot;input  : %s\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;output : %s\n&quot;</span>, argv[1], argv[2]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create pipe</span></div>
<div class="line">    <a class="code" href="a00021.html#a00159">PDPipeRef</a> pipe = <a class="code" href="a00127.html#ga4ba6a18d9e2a6583ff4f6b0cd712d8da">PDPipeCreateWithFilePaths</a>(argv[1], argv[2]);</div>
<div class="line">    <span class="keywordflow">if</span> (NULL == pipe) die(<span class="stringliteral">&quot;failed to create pipe\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// the document metadata entry of a PDF is some object somewhere, which </span></div>
<div class="line">    <span class="comment">// is pointed to from the so called Root object, so we have to add a new </span></div>
<div class="line">    <span class="comment">// object, and point Root at it!</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">// get the pipe&#39;s parser</span></div>
<div class="line">    <a class="code" href="a00021.html#a00158">PDParserRef</a> parser = <a class="code" href="a00127.html#gac21c2aa259c604582e175bb09887d5ca">PDPipeGetParser</a>(pipe);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;- adding metadata object\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// add a brand spanking new object to the PDF</span></div>
<div class="line">    <a class="code" href="a00026.html#a00152">PDObjectRef</a> meta = <a class="code" href="a00019.html#ga5c564a25ae062c5ded85d3de28bad85a">PDParserCreateNewObject</a>(parser);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// give it our meta string as its stream (the stream is where the </span></div>
<div class="line">    <span class="comment">// metadata is located); the three flags at the end are</span></div>
<div class="line">    <span class="comment">// 1. &quot;should the Length dictionary key be set automatically?&quot;, </span></div>
<div class="line">    <span class="comment">// 2. &quot;should the buffer be freed after use&quot;, and</span></div>
<div class="line">    <span class="comment">// 3. &quot;is the value sent in pre-encrypted or not?&quot;</span></div>
<div class="line">    <span class="keywordtype">char</span> *metaString = <span class="stringliteral">&quot;Hello World!&quot;</span>;</div>
<div class="line">    <a class="code" href="a00026.html#ga45ac52885d1710e54e2271870b8c13f8">PDObjectSetStream</a>(meta, metaString, strlen(metaString), <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// now we need to point Root at it, but we can&#39;t just pull it out</span></div>
<div class="line">    <span class="comment">// and change it -- we have to make a task for it</span></div>
<div class="line">    <span class="comment">// (the reason we can change meta directly is because we MADE it)</span></div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;- creating mutator for root object\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create a mutator for the root object</span></div>
<div class="line">    <a class="code" href="a00021.html#a00171">PDTaskRef</a> rootUpdater = </div>
<div class="line">        <a class="code" href="a00136.html#ga6405c8eb09d5f957e1b7911f743fd489">PDTaskCreateMutatorForPropertyType</a>(<a class="code" href="a00136.html#ggaa2f108018ee986118e960c9004e65f44a4527237134f3627f5a0d387625c6b0b2">PDPropertyRootObject</a>,</div>
<div class="line">                                           addMetadata);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// pass it the meta object as its info</span></div>
<div class="line">    <a class="code" href="a00136.html#ga4382fcaa073650fc176e1d13d587aa4d">PDTaskSetInfo</a>(rootUpdater, meta);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// add it to the pipe</span></div>
<div class="line">    <a class="code" href="a00127.html#gada11ae0da3875e70faab112dff7a7216">PDPipeAddTask</a>(pipe, rootUpdater);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;- executing pipe operation\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// execute</span></div>
<div class="line">    <a class="code" href="a00029.html#ga7bf5d17054ed63682b0cb309545ad1cc">PDInteger</a> obcount = <a class="code" href="a00127.html#ga0250f0103c839ae4ffb95a07e53ca108">PDPipeExecute</a>(pipe);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;- execution finished (%ld objects processed)\n&quot;</span>, obcount);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// clean up (note that we&#39;re not releasing meta until after PDPipeExecute</span></div>
<div class="line">    <span class="comment">// is called, or it will end up being deallocated before the task is </span></div>
<div class="line">    <span class="comment">// called)</span></div>
<div class="line">    <a class="code" href="a00138.html#ga19a72abf3c398d15e2e2ba01d38962ef">PDRelease</a>(pipe);</div>
<div class="line">    <a class="code" href="a00138.html#ga19a72abf3c398d15e2e2ba01d38962ef">PDRelease</a>(rootUpdater);</div>
<div class="line">    <a class="code" href="a00138.html#ga19a72abf3c398d15e2e2ba01d38962ef">PDRelease</a>(meta);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// task </span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="a00136.html#ga91616478cbeb225ea1dc8684f4daaa09">PDTaskResult</a> addMetadata(<a class="code" href="a00021.html#a00159">PDPipeRef</a> pipe, <a class="code" href="a00021.html#a00171">PDTaskRef</a> task, <a class="code" href="a00026.html#a00152">PDObjectRef</a> <span class="keywordtype">object</span>, <span class="keywordtype">void</span> *info)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;- task &#39;addMetadata&#39; starting\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// get the dictionary for the object</span></div>
<div class="line">    <a class="code" href="a00021.html#a00149">PDDictionaryRef</a> dict = <a class="code" href="a00026.html#gabf179b365305f5684f8014e257944e53">PDObjectGetDictionary</a>(<span class="keywordtype">object</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// we will ruthlessly explode if the object already HAS a metadata entry </span></div>
<div class="line">    <span class="comment">// (see replace-metadata.c)</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="a00123.html#gac4fa42edf1c071588eabc761ed842404">PDDictionaryGetEntry</a>(dict, <span class="stringliteral">&quot;Metadata&quot;</span>)) {</div>
<div class="line">        <span class="comment">// normally you would return PDTaskAbort here, instead of killing the </span></div>
<div class="line">        <span class="comment">// entire application</span></div>
<div class="line">        die(<span class="stringliteral">&quot;error: metadata already exists! aborting!\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// meta is our info object</span></div>
<div class="line">    <a class="code" href="a00026.html#a00152">PDObjectRef</a> meta = info;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// set the Root&#39;s metadata reference; we are setting it to a PDObject </span></div>
<div class="line">    <span class="comment">// but this translates to a PDF indirect reference, as dictionaries</span></div>
<div class="line">    <span class="comment">// cannot contain entire objects</span></div>
<div class="line">    <a class="code" href="a00123.html#ga670d173c477d22e69a89eb4640188141">PDDictionarySetEntry</a>(dict, <span class="stringliteral">&quot;Metadata&quot;</span>, meta);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;- task &#39;addMetadata&#39; finished updating root object\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// tell task handler to continue as normal</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="a00136.html#gga91616478cbeb225ea1dc8684f4daaa09ab91b10f2a3fdb44fe9a8afc269354b08">PDTaskDone</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can check out a dissection of a <code>diff</code> resulting from a tiny PDF when piped using this program on the <a class="el" href="a00014.html">Add metadata diff example</a> page.</p>
<p>In the next part we'll be conditionally replacing or inserting metadata depending on whether it exists or not. There are a couple of ways of doing this, such as always deleting the current medata object and putting in a new one, but we're going to replace or insert.</p>
<p>Next up: <a class="el" href="a00016.html">Replacing metadata</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Nov 15 2014 11:07:10 for Pajdeg by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
